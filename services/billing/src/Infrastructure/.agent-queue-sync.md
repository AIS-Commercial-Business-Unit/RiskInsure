# Agent Prompt: Sync RabbitMQ Topology Script

## Purpose
Keep `queues.ps1` synchronized with message handlers and event publishers in the Billing service.

## When to Run
- After adding new message handlers
- After adding new event subscriptions
- After creating new endpoints
- Before deploying to a new environment

## Agent Instructions

**Analyze the service and update queues.ps1by following these steps:**

### Step 1: Identify Endpoints
```
Scan for:
- All Program.cs files that call NServiceBusEnvironmentConfiguration(endpointName)
- Extract endpoint names (e.g., "RiskInsure.Billing.Api", "RiskInsure.Billing.Endpoint")
```

### Step 2: Identify Command Handlers
```
Scan for:
- All classes implementing IHandleMessages<T> where T is in a namespace ending with "Commands"
- Extract full type name of T (e.g., RiskInsure.Billing.Domain.Contracts.Commands.RecordPayment)
- Map to endpoint that contains the handler
```

### Step 3: Identify Event Publishers
```
Scan for:
- All calls to context.Publish<T>() where T is in a namespace ending with "Events"
- Extract full type name of T (e.g., RiskInsure.PublicContracts.Contracts.Events.PaymentReceived)
- Document which endpoint publishes each event
```

### Step 4: Identify Event Subscribers
```
Scan for:
- All classes implementing IHandleMessages<T> where T is in a namespace ending with "Events"
- Extract full type name of T
- Map to endpoint that contains the handler
```

### Step 5: Generate queues.ps1
```powershell
# Header
$env:RABBITMQ_CONNECTION_STRING = 'host=localhost;username=guest;password=guest'

# Shared infrastructure (once per namespace)
rabbitmqadmin declare queue name=error durable=true
rabbitmqadmin declare queue name=audit durable=true
rabbitmqadmin declare queue name=particular.monitoring durable=true

# Create endpoint for each discovered endpoint
rabbitmqadmin declare queue name=<EndpointName> durable=true

# Subscribe to commands
# Define routing intent for commands (document in comments)
# <CommandTypeName> -> <EndpointName>

# Document event publishers (as comments)
# Events published by <EndpointName>:
#   - <FullEventTypeName>

# Subscribe to events
# Bind subscriber endpoint queue to event exchange/topic
# rabbitmqadmin declare binding source=<FullEventTypeName> destination=<EndpointName> destination_type=queue routing_key="#"
```

## Example Usage

**User Prompt:**
```
Update queues.ps1 to match current handlers and subscriptions
```

**Agent Response:**
1. Scans `services/billing/src/Endpoint.In/Handlers/` for handlers
2. Finds `RecordPaymentHandler : IHandleMessages<RecordPayment>`
3. Scans for `context.Publish()` calls
4. Finds `PaymentReceived` event published
5. Updates `queues.ps1` with correct subscriptions

## Output Format

```powershell
# RabbitMQ Topology Setup for <ServiceName> Service
$env:RABBITMQ_CONNECTION_STRING = 'host=localhost;username=guest;password=guest'

# Shared infrastructure
rabbitmqadmin declare queue name=error durable=true
rabbitmqadmin declare queue name=audit durable=true
rabbitmqadmin declare queue name=particular.monitoring durable=true

# <ServiceName> endpoints
rabbitmqadmin declare queue name=<EndpointName1> durable=true
rabbitmqadmin declare queue name=<EndpointName2> durable=true

# Command routing documentation
# <CommandType> -> <EndpointName>

# Event subscriptions (cross-service integration)
# <EndpointName> publishes: <EventType1>, <EventType2>
rabbitmqadmin declare binding source=<EventType1> destination=<OtherEndpoint> destination_type=queue routing_key="#"
```

## Validation Rules

1. **Every handler requires a subscription**: Each `IHandleMessages<T>` must have a matching `subscribe` line
2. **Commands are unicast**: Each command should have exactly one subscriber
3. **Events are multicast**: Events can have zero or more subscribers
4. **Endpoint must exist**: Can't subscribe without first creating the endpoint
5. **No duplicate subscriptions**: Each endpoint should only subscribe to a message type once

## Example Scan Output

**Service:** Billing  
**Endpoints Found:**
- RiskInsure.Billing.Api (send-only)
- RiskInsure.Billing.Endpoint

**Handlers Found:**
- RiskInsure.Billing.Endpoint handles:
  - RiskInsure.Billing.Domain.Contracts.Commands.RecordPayment

**Events Published:**
- RiskInsure.Billing.Endpoint publishes:
  - RiskInsure.PublicContracts.Contracts.Events.PaymentReceived

**Generated queues.ps1:**
```powershell
# RabbitMQ Topology Setup for Billing Service
$env:RABBITMQ_CONNECTION_STRING = 'host=localhost;username=guest;password=guest'

# Shared infrastructure
rabbitmqadmin declare queue name=error durable=true
rabbitmqadmin declare queue name=audit durable=true
rabbitmqadmin declare queue name=particular.monitoring durable=true

# Billing endpoints
rabbitmqadmin declare queue name=RiskInsure.Billing.Api durable=true
rabbitmqadmin declare queue name=RiskInsure.Billing.Endpoint durable=true

# Command routing documentation
# RiskInsure.Billing.Domain.Contracts.Commands.RecordPayment -> RiskInsure.Billing.Endpoint

# Event publishers (for documentation)
# RiskInsure.Billing.Endpoint publishes:
#   - RiskInsure.PublicContracts.Contracts.Events.PaymentReceived

# Cross-service event subscriptions (add as needed)
# rabbitmqadmin declare binding source=RiskInsure.PublicContracts.Contracts.Events.PaymentReceived destination=RiskInsure.Payments.Endpoint destination_type=queue routing_key="#"
```
