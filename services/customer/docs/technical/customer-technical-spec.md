# Customer Domain - Technical Specification

**Domain**: Customer  
**Version**: 1.0.0  
**Date**: February 5, 2026

---

## API Surface Area

| HTTP Method | Endpoint | Description |
|-------------|----------|-------------|
| POST | `/api/customers` | Create a new customer |
| GET | `/api/customers/{customerId}` | Retrieve customer details |
| PUT | `/api/customers/{customerId}` | Update customer information |
| POST | `/api/customers/{customerId}/change-email` | Change customer email address |
| DELETE | `/api/customers/{customerId}` | Close customer account (GDPR) |

---

## Architecture Overview

The Customer domain manages customer identity and contact information using:
- **API Layer**: HTTP endpoints for customer CRUD operations
- **Domain Layer**: Customer entities, validation rules, and business logic
- **Infrastructure Layer**: Cosmos DB persistence and event publishing
- **Endpoint.In**: Message handlers (currently none - no subscriptions)

**Aggregate Root**: `Customer` (identified by `CustomerId`)  
**Partition Key**: `/customerId`

---

## Data Model

### Customer Document

**Cosmos DB Container**: `customer`  
**Partition Key**: `/customerId`

```csharp
public class Customer
{
    [JsonPropertyName("id")]
    public string Id { get; set; }  // Same as CustomerId
    
    [JsonPropertyName("customerId")]
    public string CustomerId { get; set; }  // Partition key (GUID)
    
    [JsonPropertyName("documentType")]
    public string DocumentType { get; set; } = "Customer";
    
    // Identity
    [JsonPropertyName("email")]
    public string Email { get; set; }  // Unique, required
    
    [JsonPropertyName("birthDate")]
    public DateTimeOffset BirthDate { get; set; }  // Required for rating
    
    [JsonPropertyName("zipCode")]
    public string ZipCode { get; set; }  // Required for territory rating
    
    // Optional Contact Information
    [JsonPropertyName("firstName")]
    public string? FirstName { get; set; }
    
    [JsonPropertyName("lastName")]
    public string? LastName { get; set; }
    
    [JsonPropertyName("phoneNumber")]
    public string? PhoneNumber { get; set; }
    
    [JsonPropertyName("mailingAddress")]
    public Address? MailingAddress { get; set; }
    
    // Status
    [JsonPropertyName("status")]
    public string Status { get; set; } = "Active";  // Active, Inactive, Suspended, Closed
    
    // Communication Preferences
    [JsonPropertyName("emailVerified")]
    public bool EmailVerified { get; set; }
    
    [JsonPropertyName("marketingOptIn")]
    public bool MarketingOptIn { get; set; }
    
    [JsonPropertyName("preferredContactMethod")]
    public string PreferredContactMethod { get; set; } = "Email";
    
    // Audit Fields
    [JsonPropertyName("createdUtc")]
    public DateTimeOffset CreatedUtc { get; set; }
    
    [JsonPropertyName("updatedUtc")]
    public DateTimeOffset UpdatedUtc { get; set; }
    
    [JsonPropertyName("_etag")]
    public string? ETag { get; set; }
}

public class Address
{
    [JsonPropertyName("street")]
    public string Street { get; set; }
    
    [JsonPropertyName("city")]
    public string City { get; set; }
    
    [JsonPropertyName("state")]
    public string State { get; set; }
    
    [JsonPropertyName("zipCode")]
    public string ZipCode { get; set; }
}
```

---

## API Endpoints

### POST /api/customers

**Purpose**: Create a new customer

**Request**:
```json
{
  "customerId": "guid",  // Generated by caller
  "email": "john@example.com",
  "birthDate": "1990-05-15",
  "zipCode": "90210"
}
```

**Validation**:
- CustomerId must be valid GUID
- Email must be unique (check existing customers)
- Email must be valid format
- Birth date must indicate age 18+
- Zip code must be 5 digits

**Response**: `201 Created`
```json
{
  "customerId": "guid",
  "email": "john@example.com",
  "status": "Active",
  "createdUtc": "2026-02-05T10:00:00Z"
}
```

**Events Published**: `CustomerCreated`

**Error Responses**:
- `400 Bad Request`: Invalid email format, age < 18, invalid zip code
- `409 Conflict`: Email already exists

---

### GET /api/customers/{customerId}

**Purpose**: Retrieve customer details

**Response**: `200 OK`
```json
{
  "customerId": "guid",
  "email": "john@example.com",
  "birthDate": "1990-05-15",
  "zipCode": "90210",
  "firstName": "John",
  "lastName": "Doe",
  "phoneNumber": "+1-555-123-4567",
  "mailingAddress": {
    "street": "123 Main St",
    "city": "Beverly Hills",
    "state": "CA",
    "zipCode": "90210"
  },
  "status": "Active",
  "emailVerified": true,
  "createdUtc": "2026-02-05T10:00:00Z"
}
```

**Error Responses**:
- `404 Not Found`: Customer does not exist

---

### PUT /api/customers/{customerId}

**Purpose**: Update customer information

**Request**:
```json
{
  "firstName": "John",
  "lastName": "Doe",
  "phoneNumber": "+1-555-123-4567",
  "mailingAddress": {
    "street": "456 Oak Ave",
    "city": "Los Angeles",
    "state": "CA",
    "zipCode": "90001"
  }
}
```

**Business Rules**:
- Cannot change customerId, email, birthDate (immutable)
- Can update name, phone, address
- Use separate endpoint for email change (requires verification)

**Response**: `200 OK` (updated customer object)

**Events Published**: `CustomerInformationUpdated`

---

### POST /api/customers/{customerId}/change-email

**Purpose**: Change customer email (requires verification)

**Request**:
```json
{
  "newEmail": "newemail@example.com"
}
```

**Process**:
1. Validate new email is unique
2. Send verification email to new address
3. Update email pending verification
4. Publish event when verified

**Response**: `202 Accepted`

**Events Published**: `ContactInformationChanged` (after verification)

---

### DELETE /api/customers/{customerId}

**Purpose**: Close customer account (GDPR right to be forgotten)

**Process**:
1. Verify no active policies exist
2. Mark customer status as "Closed"
3. Anonymize PII (email → hashed value, phone → null, address → null)
4. Retain CustomerId for transactional history

**Response**: `204 No Content`

**Events Published**: `CustomerClosed`

**Error Responses**:
- `409 Conflict`: Customer has active policies (cannot delete)

---

## Domain Services

### CustomerManager

**Interface**: `ICustomerManager`

```csharp
public interface ICustomerManager
{
    Task<Customer> CreateCustomerAsync(CreateCustomerRequest request);
    Task<Customer> GetCustomerAsync(string customerId);
    Task<Customer> UpdateCustomerAsync(string customerId, UpdateCustomerRequest request);
    Task CloseCustomerAsync(string customerId);
    Task<bool> IsEmailUniqueAsync(string email);
}
```

**Responsibilities**:
- Orchestrate customer creation workflow
- Validate business rules (age, email uniqueness)
- Coordinate with repositories
- Publish domain events

---

### CustomerValidator

**Interface**: `ICustomerValidator`

```csharp
public interface ICustomerValidator
{
    Task<ValidationResult> ValidateCreateCustomerAsync(CreateCustomerRequest request);
    Task<ValidationResult> ValidateUpdateCustomerAsync(UpdateCustomerRequest request);
    bool IsValidEmail(string email);
    bool IsValidZipCode(string zipCode);
    bool IsAgeEligible(DateTimeOffset birthDate);
}
```

**Validation Rules**:
- **Email**: Regex pattern, uniqueness check
- **Age**: Birth date results in age >= 18
- **Zip Code**: 5-digit US postal code
- **Phone**: Optional, US format if provided

---

## Repository Pattern

### ICustomerRepository

```csharp
public interface ICustomerRepository
{
    Task<Customer?> GetByIdAsync(string customerId);
    Task<Customer?> GetByEmailAsync(string email);
    Task<Customer> CreateAsync(Customer customer);
    Task<Customer> UpdateAsync(Customer customer);
    Task DeleteAsync(string customerId);
    Task<IEnumerable<Customer>> GetByStatusAsync(string status);
}
```

**Implementation Notes**:
- `GetByEmailAsync`: Cross-partition query (use sparingly, only for uniqueness check)
- `GetByIdAsync`: Efficient partition key query
- Uses optimistic concurrency (ETags)

---

## Events Published

### CustomerCreated

**Contract Location**: `services/customer/src/Domain/Contracts/Events/CustomerCreated.cs`

```csharp
namespace RiskInsure.Customer.Domain.Contracts.Events;

public record CustomerCreated(
    Guid MessageId,
    DateTimeOffset OccurredUtc,
    string CustomerId,
    string Email,
    DateTimeOffset BirthDate,
    string ZipCode,
    string IdempotencyKey
);
```

**Subscribers**: None (informational)

---

### CustomerInformationUpdated

**Contract Location**: `services/customer/src/Domain/Contracts/Events/CustomerInformationUpdated.cs`

```csharp
public record CustomerInformationUpdated(
    Guid MessageId,
    DateTimeOffset OccurredUtc,
    string CustomerId,
    Dictionary<string, object> ChangedFields,  // Field name → new value
    string IdempotencyKey
);
```

**Subscribers**: Billing, Policy (update addresses)

---

### ContactInformationChanged

```csharp
public record ContactInformationChanged(
    Guid MessageId,
    DateTimeOffset OccurredUtc,
    string CustomerId,
    string ContactType,  // Email, Phone, Address
    string? PreviousValue,
    string NewValue,
    string IdempotencyKey
);
```

---

## Security & Compliance

### PII Protection

- **Encryption at Rest**: Cosmos DB automatic encryption
- **Access Logging**: All customer data access logged with correlation IDs
- **Field-Level Encryption**: Optional for SSN (future)

### GDPR Compliance

**Right to be Forgotten**:
- `DELETE /api/customers/{customerId}` triggers anonymization
- PII fields cleared, CustomerId retained for audit
- Cannot delete if active policies exist

**Right to Data Portability**:
- `GET /api/customers/{customerId}/export` returns all customer data in JSON format

### Authentication & Authorization

- **Authentication**: OAuth 2.0 / OpenID Connect
- **Authorization**: Customer can only access their own data
- **Admin Access**: Requires elevated permissions for customer service operations

---

## Testing Strategy

### Unit Tests

- Customer validation (email format, age, zip code)
- Email uniqueness checks
- Customer creation workflow
- Update operations
- Age calculation logic

### Integration Tests (Playwright)

- Create customer end-to-end
- Retrieve customer
- Update customer information
- Email change workflow
- Delete customer (GDPR)
- Duplicate email rejection

**Test Data**:
- Valid customers (various ages, locations)
- Invalid emails
- Underage customers (< 18)
- Duplicate email attempts

---

## Performance Considerations

### Partition Strategy

- **Partition Key**: `/customerId`
- **Hot Partition Risk**: Low (customers evenly distributed by GUID)
- **Query Patterns**: Primarily point reads by CustomerId

### Caching

- **Customer Profile**: Cache in memory for duration of API request
- **Email Uniqueness**: No caching (always check Cosmos for accuracy)

### Indexing

- **Default Indexing**: All fields indexed automatically
- **Email Index**: Required for uniqueness checks (cross-partition query)

---

## Monitoring & Observability

### Metrics

- Customer creation rate (per hour)
- Email verification rate (% verified within 24h)
- Failed validations (email format, age, duplicates)
- Customer update frequency
- Data export requests (GDPR compliance)

### Logging

**Required Fields**:
- CustomerId (in all log entries)
- Operation name
- Correlation ID
- Result (success/failure)

**Log Levels**:
- **Information**: Customer created, updated, retrieved
- **Warning**: Validation failures, duplicate email attempts
- **Error**: Database errors, external service failures

---

## Error Handling

### Validation Errors (400 Bad Request)

```json
{
  "error": "ValidationFailed",
  "errors": {
    "Email": ["Email format is invalid"],
    "BirthDate": ["Customer must be at least 18 years old"],
    "ZipCode": ["Zip code must be 5 digits"]
  }
}
```

### Conflict Errors (409 Conflict)

```json
{
  "error": "EmailAlreadyExists",
  "message": "A customer with this email address already exists",
  "customerId": "existing-customer-guid"
}
```

---

## Future Enhancements

1. **Multi-Factor Authentication**: SMS or email verification codes
2. **Social Login**: Google, Facebook OAuth integration
3. **Customer Relationships**: Spouse, dependents, co-applicants
4. **Address Verification**: Integration with USPS or SmartyStreets
5. **Fraud Detection**: Duplicate email patterns, suspicious behavior
6. **Customer Segmentation**: Marketing segments, risk tiers
