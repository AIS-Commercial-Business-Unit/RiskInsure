# End-to-End Integration Test Scenario

## Test Goal
Verify complete flow: Add credit card → Initiate payment → FundTransferMgt processes → Publishes FundsSettled → Billing handles event → Deposit posted to billing account

---

## Prerequisites

### 1. Start Infrastructure

**Cosmos DB Emulator (Docker)**:
```powershell
docker run -p 8081:8081 -p 10251-10254:10251-10254 `
  --name cosmos-emulator `
  -e AZURE_COSMOS_EMULATOR_PARTITION_COUNT=10 `
  mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
```

**Azure Service Bus**:
- Create namespace: `riskinsure-dev-bus` (Standard SKU)
- Get connection string from Azure Portal

### 2. Configuration

Create `appsettings.Development.json` in each project:

**FundTransferMgt API** (`services/fundstransfermgt/src/Api/appsettings.Development.json`):
```json
{
  "ConnectionStrings": {
    "CosmosDb": "AccountEndpoint=https://localhost:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==",
    "ServiceBus": "Endpoint=sb://riskinsure-dev-bus.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=YOUR_KEY_HERE"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "NServiceBus": "Information"
    }
  },
  "PaymentGateway": {
    "AlwaysSucceed": true,
    "AlwaysFail": false,
    "FailureRate": 0.0,
    "SimulatedDelayMs": 100
  }
}
```

**FundTransferMgt Endpoint.In** (`services/fundstransfermgt/src/Endpoint.In/appsettings.Development.json`):
```json
{
  "ConnectionStrings": {
    "CosmosDb": "AccountEndpoint=https://localhost:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==",
    "ServiceBus": "Endpoint=sb://riskinsure-dev-bus.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=YOUR_KEY_HERE"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "NServiceBus": "Information"
    }
  }
}
```

**Billing Endpoint.In** (`services/billing/src/Endpoint.In/appsettings.Development.json`):
```json
{
  "ConnectionStrings": {
    "CosmosDb": "AccountEndpoint=https://localhost:8081/;AccountKey=C2y6yDjf5/R+ob0N8A7Cgv30VRDJIWEHLM+4QDU5DE2nQ9nDuVTqobD4b8mGGyPMbIZnqyMsEcaGQy67XIw/Jw==",
    "ServiceBus": "Endpoint=sb://riskinsure-dev-bus.servicebus.windows.net/;SharedAccessKeyName=RootManageSharedAccessKey;SharedAccessKey=YOUR_KEY_HERE"
  },
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "NServiceBus": "Information"
    }
  }
}
```

### 3. Start Services

**Terminal 1 - FundTransferMgt API**:
```powershell
cd services/fundstransfermgt/src/Api
dotnet run
# Should start on http://localhost:7073
```

**Terminal 2 - FundTransferMgt Endpoint.In**:
```powershell
cd services/fundstransfermgt/src/Endpoint.In
dotnet run
# Processes messages from Service Bus
```

**Terminal 3 - Billing Endpoint.In**:
```powershell
cd services/billing/src/Endpoint.In
dotnet run
# Handles FundsSettled events from FundTransferMgt
```

---

## Test Scenario Steps

### Step 1: Create Billing Account

**Request**:
```http
POST http://localhost:7071/api/billing-accounts
Content-Type: application/json

{
  "customerId": "CUST-E2E-TEST-001",
  "accountName": "Test Premium Account",
  "billingCycle": "Monthly",
  "dueDay": 15
}
```

**Expected Response** (200 OK):
```json
{
  "accountId": "BA-xxx",
  "customerId": "CUST-E2E-TEST-001",
  "accountName": "Test Premium Account",
  "status": "Active",
  "balance": 0.00,
  "totalPaid": 0.00
}
```

**Verification**:
- Billing account created in Cosmos DB
- Status = Active
- Balance = 0

### Step 2: Add Credit Card to FundTransferMgt

**Request**:
```http
POST http://localhost:7073/api/payment-methods/credit-card
Content-Type: application/json

{
  "customerId": "CUST-E2E-TEST-001",
  "cardNumber": "4532015112830366",
  "cardholderName": "John Doe",
  "expiryMonth": 12,
  "expiryYear": 2025
}
```

**Expected Response** (200 OK):
```json
{
  "paymentMethodId": "PM-xxx",
  "customerId": "CUST-E2E-TEST-001",
  "type": "CreditCard",
  "status": "Active",
  "cardDetails": {
    "cardBrand": "Visa",
    "last4Digits": "0366",
    "expiryMonth": 12,
    "expiryYear": 2025,
    "gatewayToken": "tok_xxx"
  }
}
```

**Verification**:
- PaymentMethod document created in FundTransferMgt-PaymentMethods container
- Type = CreditCard
- Status = Active
- GatewayToken generated by MockPaymentGateway

### Step 3: Initiate Fund Transfer (Payment)

**Request**:
```http
POST http://localhost:7073/api/fund-transfers
Content-Type: application/json

{
  "customerId": "CUST-E2E-TEST-001",
  "paymentMethodId": "PM-xxx",  // Use ID from Step 2
  "amount": 150.00,
  "idempotencyKey": "transfer-e2e-test-001"
}
```

**Expected Response** (200 OK):
```json
{
  "transactionId": "TXN-xxx",
  "customerId": "CUST-E2E-TEST-001",
  "paymentMethodId": "PM-xxx",
  "amount": 150.00,
  "direction": "Inbound",
  "status": "Settled",
  "authorizationCode": "auth-xxx",
  "captureCode": "capture-xxx",
  "settledUtc": "2026-02-02T12:00:00Z"
}
```

**Verification**:
1. **FundTransfer document created** in FundTransferMgt-Transactions container:
   - Status = Settled
   - AuthorizationCode populated
   - CaptureCode populated
   - SettledUtc not null

2. **FundsSettled event published** to Service Bus:
   ```json
   {
     "messageId": "guid",
     "occurredUtc": "2026-02-02T12:00:00Z",
     "customerId": "CUST-E2E-TEST-001",
     "transactionId": "TXN-xxx",
     "amount": 150.00,
     "paymentMethodId": "PM-xxx",
     "settledUtc": "2026-02-02T12:00:00Z",
     "idempotencyKey": "transfer-e2e-test-001"
   }
   ```

3. **Check logs** in FundTransferMgt Endpoint.In terminal - should see:
   ```
   [Information] Fund transfer TXN-xxx settled successfully
   [Information] Publishing FundsSettled event for customer CUST-E2E-TEST-001, amount 150.00
   ```

### Step 4: Verify Billing Handles FundsSettled Event

**Wait 5-10 seconds** for event processing, then check logs in Billing Endpoint.In terminal:

**Expected Logs**:
```
[Information] Received FundsSettled event for customer CUST-E2E-TEST-001, transaction TXN-xxx, amount 150.00
[Information] Applying settled funds to billing account for customer CUST-E2E-TEST-001
[Information] Payment of 150.00 recorded successfully for account BA-xxx
```

**Verification**:
1. **Query Billing Account**:
   ```http
   GET http://localhost:7071/api/billing-accounts/BA-xxx
   ```

2. **Expected Response**:
   ```json
   {
     "accountId": "BA-xxx",
     "customerId": "CUST-E2E-TEST-001",
     "accountName": "Test Premium Account",
     "status": "Active",
     "balance": 0.00,
     "totalPaid": 150.00  // ✅ Updated!
   }
   ```

3. **Check Cosmos DB** (FundTransferMgt-Transactions container):
   - FundTransfer document exists with TransactionId = TXN-xxx
   - Status = Settled

4. **Check Cosmos DB** (Billing container - if exists):
   - BillingAccount document shows totalPaid = 150.00

---

## Test Scenario 2: Refund Flow

### Step 5: Process Refund

**Request**:
```http
POST http://localhost:7073/api/refunds
Content-Type: application/json

{
  "originalTransactionId": "TXN-xxx",  // Use ID from Step 3
  "amount": 50.00,
  "reason": "Partial refund - customer request",
  "idempotencyKey": "refund-e2e-test-001"
}
```

**Expected Response** (200 OK):
```json
{
  "refundId": "REF-xxx",
  "originalTransactionId": "TXN-xxx",
  "customerId": "CUST-E2E-TEST-001",
  "amount": 50.00,
  "reason": "Partial refund - customer request",
  "gatewayRefundId": "refund-xxx",
  "refundedUtc": "2026-02-02T12:05:00Z"
}
```

**Verification**:
1. **Refund document created** in FundTransferMgt-Transactions container
2. **FundsRefunded event published** to Service Bus
3. **Check logs** in Billing Endpoint.In terminal:
   ```
   [Information] Received FundsRefunded event for customer CUST-E2E-TEST-001, refund amount 50.00
   [Information] Reversing payment of 50.00 for billing account BA-xxx
   ```

### Step 6: Verify Billing Account Updated

**Request**:
```http
GET http://localhost:7071/api/billing-accounts/BA-xxx
```

**Expected Response**:
```json
{
  "accountId": "BA-xxx",
  "customerId": "CUST-E2E-TEST-001",
  "accountName": "Test Premium Account",
  "status": "Active",
  "balance": 0.00,
  "totalPaid": 100.00  // ✅ Was 150.00, now reduced by 50.00 refund!
}
```

---

## Success Criteria

✅ **Step 1**: Billing account created successfully  
✅ **Step 2**: Credit card added and tokenized  
✅ **Step 3**: Payment processed, settled, FundsSettled event published  
✅ **Step 4**: Billing receives event and updates totalPaid to 150.00  
✅ **Step 5**: Refund processed, FundsRefunded event published  
✅ **Step 6**: Billing receives event and reduces totalPaid to 100.00  

---

## Troubleshooting

### Issue: FundsSettled event not received by Billing

**Diagnosis**:
1. Check Service Bus topic exists
2. Verify Billing Endpoint.In subscribed to topic
3. Check NServiceBus configuration in both endpoints
4. Verify PublicContracts referenced in both projects

**Fix**:
- Ensure `NServiceBusConfigurationExtensions.cs` properly configures routing
- Verify message conventions detect events (namespace ends with "Events")

### Issue: Payment method validation fails

**Diagnosis**:
1. Check Luhn algorithm implementation
2. Verify card number is valid test card: `4532015112830366` (Visa)
3. Check ABA routing number validation

**Fix**:
- Use valid test card numbers (see Test Data section below)

### Issue: Cosmos DB connection fails

**Diagnosis**:
1. Verify Cosmos DB emulator running: `docker ps`
2. Check connection string in appsettings.Development.json
3. Verify `CosmosDbInitializer` ran successfully

**Fix**:
```powershell
# Restart Cosmos DB emulator
docker stop cosmos-emulator
docker rm cosmos-emulator
docker run -p 8081:8081 -p 10251-10254:10251-10254 `
  --name cosmos-emulator `
  -e AZURE_COSMOS_EMULATOR_PARTITION_COUNT=10 `
  mcr.microsoft.com/cosmosdb/linux/azure-cosmos-emulator:latest
```

---

## Test Data

### Valid Test Credit Cards (Luhn compliant)

| Card Number        | Brand      | CVV | Expiry     |
|--------------------|------------|-----|------------|
| 4532015112830366   | Visa       | 123 | 12/2025    |
| 5425233430109903   | MasterCard | 456 | 06/2026    |
| 374245455400126    | Amex       | 7890| 09/2025    |
| 6011000991001201   | Discover   | 321 | 03/2027    |

### Valid Test ACH Accounts

| Routing Number | Account Number | Account Holder   |
|----------------|----------------|------------------|
| 011000015      | 123456789      | Jane Smith       |
| 122105155      | 987654321      | Bob Johnson      |

---

## Cleanup

After testing, clean up test data:

```powershell
# Stop all services (Ctrl+C in each terminal)

# Clean Cosmos DB containers
az cosmosdb sql container delete `
  --account-name riskinsure-cosmos `
  --database-name RiskInsure `
  --name FundTransferMgt-PaymentMethods

az cosmosdb sql container delete `
  --account-name riskinsure-cosmos `
  --database-name RiskInsure `
  --name FundTransferMgt-Transactions

# Or just restart emulator to wipe all data
docker stop cosmos-emulator
docker rm cosmos-emulator
```

---

## Next Steps

After successful E2E test:

1. **Create Playwright integration tests** to automate this scenario
2. **Add error handling tests** (authorization failures, invalid cards, etc.)
3. **Test concurrent scenarios** (multiple transfers in parallel)
4. **Add monitoring** (Application Insights, metrics)
5. **Deploy to Azure** (Container Apps, managed Cosmos DB, Service Bus)
