name: 'Terraform - Main Pipeline'

on:
  # push:
  #   branches: 
  #     - main
  #     - Dev
  #   paths:
  #     - 'platform/infra/**'
  #     - 'services/**'
  #     - 'platform/templates/**'
  #     - '.github/workflows/**'
  # pull_request:
  #   branches: 
  #     - main
  #     - Dev
  #   paths:
  #     - 'platform/infra/**'
  workflow_dispatch:
    inputs:
      workflow_mode:
        description: 'What to run'
        type: choice
        required: true
        default: 'all'
        options:
          - infrastructure-only
          - deploy-services-only
          - full-deployment
      environment:
        description: 'Environment to deploy'
        type: choice
        required: true
        default: 'dev'
        options:
          - dev
          - staging
          - prod
      terraform_layer:
        description: 'Infrastructure layer (for infrastructure-only mode)'
        type: choice
        required: true
        default: 'all'
        options:
          - all
          - foundation
          - shared-services
          - services-environment
      services_to_deploy:
        description: 'Services to deploy (comma-separated or "all")'
        type: string
        required: true
        default: 'all'
      terraform_action:
        description: 'Terraform action'
        type: choice
        required: true
        default: 'plan'
        options:
          - plan
          - apply

jobs:
  # ==========================================================================
  # Determine what to run
  # ==========================================================================
  determine-workflow:
    name: 'Determine Workflow'
    runs-on: ubuntu-latest
    outputs:
      run_infrastructure: ${{ steps.decide.outputs.run_infrastructure }}
      run_services: ${{ steps.decide.outputs.run_services }}
      environment: ${{ steps.decide.outputs.environment }}
      terraform_action: ${{ steps.decide.outputs.terraform_action }}
      terraform_layer: ${{ steps.decide.outputs.terraform_layer }}
      services_to_deploy: ${{ steps.decide.outputs.services_to_deploy }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Decide what to run
        id: decide
        run: |
          RUN_INFRA="true"
          RUN_SERVICES="true"
          ENV="dev"
          ACTION="plan"
          LAYER="all"
          SERVICES="all"
          
          # Workflow dispatch
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ENV="${{ github.event.inputs.environment }}"
            ACTION="${{ github.event.inputs.terraform_action }}"
            LAYER="${{ github.event.inputs.terraform_layer }}"
            SERVICES="${{ github.event.inputs.services_to_deploy }}"
            
            case "${{ github.event.inputs.workflow_mode }}" in
              infrastructure-only)
                RUN_INFRA="true"
                ;;
              deploy-services-only)
                RUN_SERVICES="true"
                ;;
              full-deployment)
                RUN_INFRA="true"
                RUN_SERVICES="true"
                ;;
            esac
          
          # Push to main or Dev
          elif [ "${{ github.event_name }}" == "push" ]; then
            ACTION="plan"
            git diff --name-only HEAD^ HEAD > changed_files.txt
            
            if grep -q "^platform/infra/" changed_files.txt; then
              RUN_INFRA="true"
            fi
            
            if grep -qE "^services/|^platform/templates/" changed_files.txt; then
              RUN_SERVICES="true"
            fi
          
          # Pull request
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            ACTION="plan"
            if git diff --name-only origin/main...HEAD | grep -q "^platform/infra/"; then
              RUN_INFRA="true"
            fi
          fi
          
          echo "run_infrastructure=$RUN_INFRA" >> $GITHUB_OUTPUT
          echo "run_services=$RUN_SERVICES" >> $GITHUB_OUTPUT
          echo "environment=$ENV" >> $GITHUB_OUTPUT
          echo "terraform_action=$ACTION" >> $GITHUB_OUTPUT
          echo "terraform_layer=$LAYER" >> $GITHUB_OUTPUT
          echo "services_to_deploy=$SERVICES" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ Workflow Decision:"
          echo "  - Run Infrastructure: $RUN_INFRA"
          echo "  - Run Services: $RUN_SERVICES"
          echo "  - Environment: $ENV"
          echo "  - Action: $ACTION"

  # ==========================================================================
  # Call Infrastructure Workflow
  # ==========================================================================
  call-infrastructure:
    name: 'Run Infrastructure'
    needs: determine-workflow
    if: needs.determine-workflow.outputs.run_infrastructure == 'true'
    uses: ./.github/workflows/infrastructure.yaml
    with:
      environment: ${{ needs.determine-workflow.outputs.environment }}
      terraform_layer: ${{ needs.determine-workflow.outputs.terraform_layer }}
      terraform_action: ${{ needs.determine-workflow.outputs.terraform_action }}
    secrets: inherit

  # ==========================================================================
  # Call Build & Deploy Workflow
  # ==========================================================================
  call-build-deploy:
    name: 'Run Build & Deploy'
    needs: [determine-workflow, call-infrastructure]
    if: |
      always() &&
      needs.determine-workflow.outputs.run_services == 'true' &&
      (needs.call-infrastructure.result == 'success' || needs.call-infrastructure.result == 'skipped')
    uses: ./.github/workflows/build-and-deploy.yaml
    with:
      environment: ${{ needs.determine-workflow.outputs.environment }}
      services: ${{ needs.determine-workflow.outputs.services_to_deploy }}
    secrets: inherit

  # ==========================================================================
  # Summary
  # ==========================================================================
  summary:
    name: 'ðŸ“Š Pipeline Summary'
    needs: [determine-workflow, call-infrastructure, call-build-deploy]
    if: always()
    runs-on: ubuntu-latest
    
    steps:
      - name: Generate Summary
        run: |
          echo "# ðŸš€ RiskInsure Deployment Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** \`${{ needs.determine-workflow.outputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** \`${{ github.event_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“‹ Workflow Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Infrastructure | ${{ needs.call-infrastructure.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Deploy | ${{ needs.call-build-deploy.result }} |" >> $GITHUB_STEP_SUMMARY