name: 'Fix Terraform State - Remove Resource Group'

# This is a ONE-TIME workflow to fix the Terraform state
# It removes the resource group from state (which is now a data source)
# After running this successfully, you can delete this workflow file

on:
  push:
    branches:
      - Dev
    paths:
      - 'platform/infra/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment (dev/staging/prod)'
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
        default: dev
      confirm:
        description: 'Type "REMOVE" to confirm state removal'
        required: true
        type: string
        default: 'REMOVE'

env:
  TERRAFORM_VERSION: '1.11.4'

jobs:
  remove-resource-group-from-state:
    name: 'Remove Resource Group from State'
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        shell: bash
        working-directory: platform/infra/foundation

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -input=false
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: List Current State
        run: |
          echo "ðŸ“‹ Current Terraform state:"
          terraform state list
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Remove Resource Group from State
        run: |
          echo "ðŸ—‘ï¸ Removing resource group from state..."
          
          # Try both possible state paths
          REMOVED=false
          
          if terraform state list | grep -q "^azurerm_resource_group.riskinsure$"; then
            terraform state rm azurerm_resource_group.riskinsure
            echo "âœ… Successfully removed azurerm_resource_group.riskinsure from state"
            REMOVED=true
          fi
          
          if terraform state list | grep -q "^data.azurerm_resource_group.riskinsure$"; then
            terraform state rm data.azurerm_resource_group.riskinsure
            echo "âœ… Successfully removed data.azurerm_resource_group.riskinsure from state"
            REMOVED=true
          fi
          
          if [ "$REMOVED" = false ]; then
            echo "â„¹ï¸ Resource group not found in state (already removed or never existed)"
          fi
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify State After Removal
        run: |
          echo "ðŸ“‹ Updated Terraform state:"
          terraform state list
          
          # Verify both possible resource paths are gone
          if terraform state list | grep -qE "^(data\.)?azurerm_resource_group\.riskinsure$"; then
            echo "âŒ ERROR: Resource group still exists in state!"
            exit 1
          else
            echo "âœ… Verified: Resource group successfully removed from state"
          fi
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Summary
        run: |
          echo "## âœ… State Fix Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The resource group has been removed from Terraform state." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Run your normal terraform plan/apply workflow" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify the deployment succeeds" >> $GITHUB_STEP_SUMMARY
          echo "3. Delete this workflow file (.github/workflows/fix-terraform-state.yaml)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**What happened:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Resource group remains in Azure (unchanged)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform now treats it as a data source (read-only)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No resources were deleted from Azure" >> $GITHUB_STEP_SUMMARY
