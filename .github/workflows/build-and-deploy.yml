name: 'Build & Deploy Services (Reusable)'

on:
  workflow_call:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        type: string
      services_to_deploy:
        description: 'Comma-separated list of services (e.g., billing,policy,customer,fundstransfermgt,ratingunderwriting)'
        required: true
        type: string
      acr_login_server:
        description: 'ACR login server'
        required: true
        type: string
      acr_name:
        description: 'ACR name'
        required: true
        type: string
      resource_group_name:
        description: 'Resource group name'
        required: true
        type: string
      apps_shared_identity_id:
        description: 'User-assigned managed identity ID'
        required: true
        type: string
      terraform_action:
        description: 'Terraform action (plan or apply)'
        required: false
        type: string
        default: 'plan'

env:
  TERRAFORM_VERSION: '1.11.4'

permissions:
  contents: read
  id-token: write

concurrency:
  group: riskinsure-services-${{ inputs.environment }}
  cancel-in-progress: false

jobs:
  # ==========================================================================
  # Pre-Flight Checks - Verify UAMI exists before proceeding
  # ==========================================================================
  preflight-checks:
    name: 'Pre-Flight Checks'
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Verify Managed Identity Exists
        shell: bash
        run: |
          UAMI_ID="${{ inputs.apps_shared_identity_id }}"
          RG="${{ inputs.resource_group_name }}"
          
          echo " Verifying UAMI: $UAMI_ID (RG: $RG)"
          
          if [ "$UAMI_ID" = "N/A" ] || [ -z "$UAMI_ID" ]; then
            echo " No UAMI ID provided. Infrastructure must be deployed first."
            exit 1
          fi
          
          UAMI_NAME=$(basename "$UAMI_ID")
          az identity show -n "$UAMI_NAME" -g "$RG" --query "id" -o tsv
          echo " UAMI verified: $UAMI_NAME"

  # ==========================================================================
  # Parse Services
  # ==========================================================================
  parse-services:
    name: 'Parse Services'
    runs-on: ubuntu-latest
    needs: preflight-checks

    outputs:
      services_matrix: ${{ steps.parse.outputs.matrix }}

    steps:
      - name: Parse services_to_deploy into JSON array
        id: parse
        shell: bash
        run: |
          SERVICES_INPUT="${{ inputs.services_to_deploy }}"
          
          # If "all", expand to all services
          if [ "$SERVICES_INPUT" = "all" ]; then
            SERVICES_INPUT="billing,policy,customer,fundstransfermgt,ratingunderwriting"
          fi
          
          # Convert "billing,policy,customer" -> ["billing","policy","customer"]
          SERVICES_ARRAY=$(echo "$SERVICES_INPUT" | jq -R 'split(",") | map(select(length > 0))')
          
          echo "matrix={\"service\":$SERVICES_ARRAY}" >> "$GITHUB_OUTPUT"
          echo "Parsed services: $SERVICES_ARRAY"

  # ==========================================================================
  # Build & Push Docker Images (only if terraform_action == 'apply')
  # ==========================================================================
  build-and-push:
    name: 'Build & Push: ${{ matrix.service }}'
    runs-on: ubuntu-latest
    needs: parse-services
    if: inputs.terraform_action == 'apply'

    permissions:
      id-token: write
      contents: read

    strategy:
      matrix: ${{ fromJson(needs.parse-services.outputs.services_matrix) }}
      fail-fast: false

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: ACR Login
        shell: bash
        run: |
          ACR_NAME="${{ inputs.acr_name }}"
          echo " Logging into ACR: $ACR_NAME"
          az acr login --name "$ACR_NAME"

      - name: Determine service path
        id: paths
        shell: bash
        run: |
          SERVICE="${{ matrix.service }}"
          case "$SERVICE" in
            ratingunderwriting)
              SERVICE_DIR="services/ratingandunderwriting"
              ;;
            *)
              SERVICE_DIR="services/$SERVICE"
              ;;
          esac
          
          echo "service_dir=$SERVICE_DIR" >> "$GITHUB_OUTPUT"

      - name: Build API Image
        shell: bash
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE_DIR="${{ steps.paths.outputs.service_dir }}"
          ACR_SERVER="${{ inputs.acr_login_server }}"
          IMAGE_TAG="${{ github.sha }}"
          
          API_IMAGE="$ACR_SERVER/$SERVICE-api:$IMAGE_TAG"
          
          echo " Building API image: $API_IMAGE"
          docker build \
            -t "$API_IMAGE" \
            -f "$SERVICE_DIR/src/${SERVICE^}.Api/Dockerfile" \
            --build-arg SERVICE_NAME=$SERVICE \
            .
          
          docker push "$API_IMAGE"
          echo " API image pushed: $API_IMAGE"

      - name: Build Endpoint.In Image
        shell: bash
        run: |
          SERVICE="${{ matrix.service }}"
          SERVICE_DIR="${{ steps.paths.outputs.service_dir }}"
          ACR_SERVER="${{ inputs.acr_login_server }}"
          IMAGE_TAG="${{ github.sha }}"
          
          ENDPOINT_IMAGE="$ACR_SERVER/$SERVICE-endpoint-in:$IMAGE_TAG"
          
          echo " Building Endpoint.In image: $ENDPOINT_IMAGE"
          docker build \
            -t "$ENDPOINT_IMAGE" \
            -f "$SERVICE_DIR/src/${SERVICE^}.Endpoint.In/Dockerfile" \
            --build-arg SERVICE_NAME=$SERVICE \
            .
          
          docker push "$ENDPOINT_IMAGE"
          echo " Endpoint.In image pushed: $ENDPOINT_IMAGE"

  # ==========================================================================
  # Deploy Container Apps (using Terraform)
  # ==========================================================================
  deploy-apps:
    name: 'Deploy Container Apps'
    runs-on: ubuntu-latest
    needs: [parse-services, build-and-push]
    if: |
      always() &&
      (needs.build-and-push.result == 'success' || needs.build-and-push.result == 'skipped')

    permissions:
      id-token: write
      contents: read

    defaults:
      run:
        shell: bash
        working-directory: platform/infra/services

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init -input=false
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Validate
        run: terraform validate

      - name: Terraform Plan
        run: |
          terraform plan \
            -var="environment=${{ inputs.environment }}" \
            -var="image_tag=${{ github.sha }}" \
            -out=tfplan \
            -input=false
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Terraform Apply
        if: inputs.terraform_action == 'apply'
        run: terraform apply -auto-approve tfplan
        env:
          ARM_USE_OIDC: true
          ARM_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          ARM_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # ==========================================================================
  # Health Check (verify all services are running)
  # ==========================================================================
  health-check:
    name: 'Health Check: ${{ matrix.service }}'
    runs-on: ubuntu-latest
    needs: [parse-services, deploy-apps]
    if: inputs.terraform_action == 'apply'

    permissions:
      id-token: write
      contents: read

    strategy:
      matrix:
        service:
          - billing
          - policy
          - customer
          - fundstransfermgt
          - ratingunderwriting
      fail-fast: false

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check API Container App
        shell: bash
        run: |
          RG="${{ inputs.resource_group_name }}"
          SERVICE="${{ matrix.service }}"
          APP_NAME="$SERVICE-api"
          
          echo " Checking API: $APP_NAME (RG: $RG)"
          
          STATUS=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RG" \
            --query "properties.runningStatus" \
            -o tsv 2>/dev/null || echo "NotFound")
          
          echo "Status: $STATUS"
          
          if [ "$STATUS" = "Running" ]; then
            echo " $APP_NAME is running"
          else
            echo " $APP_NAME status: $STATUS"
          fi

      - name: Check Endpoint.In Container App
        shell: bash
        run: |
          RG="${{ inputs.resource_group_name }}"
          SERVICE="${{ matrix.service }}"
          APP_NAME="$SERVICE-endpoint-in"
          
          echo " Checking Endpoint.In: $APP_NAME (RG: $RG)"
          
          STATUS=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RG" \
            --query "properties.runningStatus" \
            -o tsv 2>/dev/null || echo "NotFound")
          
          echo "Status: $STATUS"
          
          if [ "$STATUS" = "Running" ]; then
            echo " $APP_NAME is running"
          else
            echo " $APP_NAME status: $STATUS"
          fi

      - name: Get Container App URL
        shell: bash
        run: |
          RG="${{ inputs.resource_group_name }}"
          SERVICE="${{ matrix.service }}"
          APP_NAME="$SERVICE-api"
          
          FQDN=$(az containerapp show \
            --name "$APP_NAME" \
            --resource-group "$RG" \
            --query "properties.configuration.ingress.fqdn" \
            -o tsv 2>/dev/null || echo "N/A")
          
          if [ "$FQDN" != "N/A" ]; then
            echo " API URL: https://$FQDN"
          else
            echo " No FQDN available for $APP_NAME"
          fi